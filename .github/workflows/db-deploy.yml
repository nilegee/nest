name: Deploy migrations
on:
  workflow_dispatch:
    inputs:
      ref:
        description: Git ref to deploy from
        default: main
jobs:
  deploy:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref }}
      - uses: supabase/setup-cli@v1
        with:
          version: latest
      - name: Guard main branch
        run: |
          if [[ "${{ inputs.ref }}" != "main" ]]; then
            echo "Error: Deploy only from main branch."
            exit 1
          fi
      - name: Apply migrations
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          if [[ -z "${DATABASE_URL}" ]]; then
            echo "❌ DATABASE_URL secret is missing"; exit 1
          fi
          echo "Supabase CLI version:"
          supabase --version
          echo "➡️  Applying new migrations to remote database..."
          # SAFE: apply only pending migrations; no destructive reset
          supabase db push --db-url "$DATABASE_URL"